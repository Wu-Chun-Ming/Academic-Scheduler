<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<div th:fragment="courseForm(actionUrl)"
	th:with="method=${method} ?: 'POST', 
			isEdit=${isEdit} ?: false, 
			enableDelete=${enableDelete} ?: false">
    <!-- Success Message -->
	<div class="alert alert-success alert-dismissible fade show" role="alert" th:if="${successMessage}">
	    <span th:text="${successMessage}"></span>
	    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
	</div>

    <form class="form" th:object="${course}" th:action="${actionUrl}" th:method="POST" th:csrf="true">
		<input type="hidden" name="_method" th:if="${method != 'POST'}" th:value="${method}">

		<!-- Error Messages -->
		<div class="alert alert-danger" th:if="${#fields.hasErrors()}">
			<ul>
				<li th:each="err : ${#fields.allErrors()}" th:text="${err}"></li>
			</ul>
		</div>

        <!-- Course Code -->
        <div class="mb-3">
            <label for="code" class="form-label fw-bold">Course Code *</label>
            <input type="text" class="form-control" th:field="*{code}" placeholder="Enter Course Code" autocomplete="off" oninput="this.value = this.value.toUpperCase()" required>
        </div>

        <!-- Course Name -->
        <div class="mb-3">
            <label for="name" class="form-label fw-bold">Course Name *</label>
            <input type="text" class="form-control" th:field="*{name}" placeholder="Enter Course Name" autocomplete="off" oninput="this.value = this.value.toUpperCase()" required>
        </div>

        <!-- Year -->
        <div class='mb-3'>
            <label for="year" class="form-label fw-bold">Year:</label>
            <select class="form-select" id="year" name="year" required>
                <option value="" selected disabled>Select Year</option>
                <option th:each="year : ${years}" 
						th:value="${year.value}" 
						th:text="${year.label}"
                        th:selected="${year.value == course.year}">
				</option>
            </select>
        </div>

        <!-- Semester -->
        <div class='mb-3'>
            <label for="semester" class="form-label fw-bold">Semester:</label>
            <select class="form-select" id="semester" name="semester" required>
                <option value="" selected disabled>Select Semester</option>
                <option th:each="semester : ${semesters}" 
						th:value="${semester.value}" 
						th:text="${semester.label}"
                        th:selected="${semester.value == course.semester}">
				</option>
            </select>
        </div>

        <!-- Timeslots -->
        <div class='mb-3'>
            <label class="form-label fw-bold">Time Slots:</label>
            <div>
                <div class="border px-3" th:each="timeslotType : ${timeslotTypes}">
                    <label class="text-decoration-underline my-2" th:text="${#strings.capitalize(timeslotType)}"></label>

                    <!-- Check if timeslots exist -->
                    <div th:if="${timeslotType == 'lecture' ? !#lists.isEmpty(course.lecture) :
                                timeslotType == 'tutorial' ? !#lists.isEmpty(course.tutorial) :
                                !#lists.isEmpty(course.practical)}">
                        <div th:each="item, status : ${timeslotType == 'lecture' ? course.lecture :
                                                        timeslotType == 'tutorial' ? course.tutorial :
                                                        course.practical}" 
                            th:id="${timeslotType + '-container'}">
                            <div class="timeslot-group mb-3 d-flex align-items-center">
                                <!-- Day -->
                                <label class="ms-2 me-2">Day:</label>
                                <select class="form-select d-inline w-auto" th:name="${timeslotType} + '[' + ${status.index} + '].day'">
                                    <option value="" disabled th:selected="${item.day == null}">Select Day</option>
                                    <option th:each="day : ${dayOfWeek}"
                                            th:value="${day.value}"
                                            th:text="${day.label}"
                                            th:selected="${item.day == day.value}">
                                    </option>
                                </select>

                                <!-- Start time -->
                                <label class="ms-2 me-2">Start:</label>
                                <input type="time" class="form-control d-inline w-auto" 
                                        th:name="${timeslotType} + '[' + ${status.index} + '].start'" 
                                        th:value="${item.start}">

                                <!-- End time -->
                                <label class="ms-2 me-2">End:</label>
                                <input type="time" class="form-control d-inline w-auto" 
                                        th:name="${timeslotType} + '[' + ${status.index} + '].end'" 
                                        th:value="${item.end}">

                                <!-- Add Timeslot button only for lectures -->
                                <button type="button" class="btn btn-secondary ms-2" 
                                        th:if="${timeslotType == 'lecture'}"
                                        th:attr="data-type=${timeslotType}" 
                                        onclick="addTimeslot(this.getAttribute('data-type'))">
                                    Add Timeslot
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- If no timeslots exist -->
                    <div th:if="${#lists.isEmpty(course.lecture) && timeslotType == 'lecture' ||
                                 #lists.isEmpty(course.tutorial) && timeslotType == 'tutorial' ||
                                 #lists.isEmpty(course.practical) && timeslotType == 'practical'}" 
                        th:id="${timeslotType + '-container'}">
                        <div class="timeslot-group mb-3 d-flex align-items-center">
                            <label class="ms-2 me-2">Day:</label>
                            <select class="form-select d-inline w-auto" th:name="${timeslotType} + '[0].day'">
                                <option value="" disabled selected>Select Day</option>
                                <option th:each="day : ${dayOfWeek}" 
                                        th:value="${day.value}" 
                                        th:text="${day.label}">
                                </option>
                            </select>

                            <label class="ms-2 me-2">Start:</label>
                            <input type="time" class="form-control d-inline w-auto" th:name="${timeslotType} + '[0].start'">

                            <label class="ms-2 me-2">End:</label>
                            <input type="time" class="form-control d-inline w-auto" th:name="${timeslotType} + '[0].end'">

                            <button type="button" class="btn btn-secondary ms-2" 
                                    th:if="${timeslotType == 'lecture'}"
                                    th:attr="data-type=${timeslotType}" 
                                    onclick="addTimeslot(this.getAttribute('data-type'))">
                                Add Timeslot
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex">
			<!-- Submit Button -->
			<div>
				<button type="submit" class="btn btn-primary">Submit</button>
			</div>
			<!-- Reset Button -->
			<div class="ms-2">
				<button type="reset" class="btn btn-secondary">Reset</button>
			</div>
			
			<!-- Delete Button -->
			<div class="ms-auto" th:if="${enableDelete}">
				<button type="button" class="btn btn-danger" onclick="if(confirm('Delete this course permanently?')) document.getElementById('deleteForm').submit();">
					Delete
				</button>
			</div>
		</div>
    </form>

	<form id="deleteForm"
		method="POST"
		style="display: none;"
		th:action="@{/course/{code}(code=${code})}"
		th:if="${enableDelete}">
	    <input type="hidden" name="_method" value="DELETE">
	</form>

    <script layout:fragment="scripts" th:inline="javascript">
        /*<![CDATA[*/
        const dayOfWeek = [[${dayOfWeek}]];
        /*]]>*/
        function addTimeslot(timeslotType) {
            const container = document.getElementById(`${timeslotType}-container`);
            const index = container.querySelectorAll('.timeslot-group').length;

            let optionsHtml = `<option value="" disabled selected>Select Day</option>`;
            dayOfWeek.forEach(day => {
                optionsHtml += `<option value="${day.value}">${day.label}</option>`;
            });

            const html = `
                <div class="timeslot-group mb-3 d-flex align-items-center">
                    <label class="ms-2 me-2">Day:</label>
                    <select class="form-select d-inline w-auto" name="${timeslotType}[${index}].day">
                        ${optionsHtml}
                    </select>

                    <label class="ms-2 me-2">Start:</label>
                    <input type="time" class="form-control d-inline w-auto" name="${timeslotType}[${index}].start">

                    <label class="ms-2 me-2">End:</label>
                    <input type="time" class="form-control d-inline w-auto" name="${timeslotType}[${index}].end">
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }
    </script>
</div>

</html>