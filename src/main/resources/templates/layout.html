<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head>
	<title layout:title-pattern="${title}" th:text="${title ?: 'AIO STUDY'}"></title>
	<link rel="stylesheet" th:href="@{/css/app.css}">
	<link rel="stylesheet" th:href="@{/css/flatly-theme-bootstrap.min.css}">
	<th:block layout:fragment="head"></th:block>
</head>

<body>
	<!-- Header -->
	<header class="bg-secondary text-black py-3 text-center shadow">
		<h1 class="font-weight-bold" th:text="${header ?: 'AIO'}"></h1>
	</header>

	<main class="container my-4">
		<!-- Navigation bar -->
		<div th:replace="~{fragments/navbar :: navbar}"></div>

		<!-- Profile Modal -->
		<div id="profileModalContent"></div>

		<!-- Main content -->
		<section layout:fragment="content"></section>
	</main>

	<!-- Footer -->
	<div th:replace="~{fragments/footer :: footer}"></div>

	<!-- Scripts -->
	<script th:src="@{/js/app.js}"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
	<th:block layout:fragment="scripts"></th:block>

	<script>
	document.getElementById('profileBtn').addEventListener('click', function() {
		fetch('/profile/modal')
		.then(response => response.text())
		.then(html => {
			const modalContent = document.getElementById('profileModalContent');
			modalContent.innerHTML = html;

			// Manually show the modal
			const profileModalEl = document.getElementById('profileModal');
			const profileModal = new bootstrap.Modal(profileModalEl);
			profileModal.show();

			// Attach the submit handler to the newly injected form
			const profileForm = document.getElementById('profileForm');
			profileForm.addEventListener('submit', function(e) {
				e.preventDefault();
				const formData = new FormData(profileForm);

				fetch(profileForm.action, {
					method: 'POST',
					body: formData
				})
				.then(response => response.json())
				.then(result => {
					if (result.status === "success") {
						profileModal.hide();
						
						alert('Profile updated successfully!');

						profileModalEl.addEventListener('hidden.bs.modal', function() {
							window.location.href = result.redirectUrl;
						}, { once: true });
					} else {
						const errorDiv = profileModalEl.querySelector(".alert-danger");
						errorDiv.innerHTML = "<ul>" + result.errors.map(err => `<li>${err}</li>`).join("") + "</ul>";
						errorDiv.style.display = "block";

						// Scroll the modal content to the error messages
						errorDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
					}
				})
				.catch(err => console.error(err));
			});
        })
        .catch(err => console.error('Failed to load profile modal:', err));
	});
	</script>
</body>

</html>